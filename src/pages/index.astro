---
// src/pages/index.astro
import BaseLayout from '../layouts/BaseLayout.astro';

const pageTitle = "é¦–é ï½œP.SnowcNEWS";

// â˜…â˜…â˜… ä¿®æ”¹ 1ï¼šåŠ å…¥ : any[] é¡å‹å®£å‘Šï¼Œè§£æ±º allPosts ç´…å­— â˜…â˜…â˜…
let allPosts: any[] = [];
try {
  // 1. æŠ“å–æ‰€æœ‰æ–‡ç« 
  // å¦‚æœ ./posts/ è³‡æ–™å¤¾ä¸å­˜åœ¨æˆ–æ²’æœ‰ .md æª”æ¡ˆï¼Œé€™è£¡å¯èƒ½æœƒå ±éŒ¯æˆ–å›å‚³ç©ºé™£åˆ—
  allPosts = await Astro.glob('./posts/*.md');
} catch (error) {
  console.log("å°šæœªå»ºç«‹æ–‡ç« æˆ–è·¯å¾‘éŒ¯èª¤", error);
}

// 2. æ’åºï¼šæœ€æ–°çš„æ—¥æœŸæ’å‰é¢
allPosts.sort((a, b) => {
  // åŠ å…¥é˜²å‘†ï¼šå¦‚æœæ²’æœ‰ pubDateï¼Œè¦–ç‚º 0 (æœ€èˆŠ)
  const dateA = a.frontmatter.pubDate ? new Date(a.frontmatter.pubDate).valueOf() : 0;
  const dateB = b.frontmatter.pubDate ? new Date(b.frontmatter.pubDate).valueOf() : 0;
  return dateB - dateA;
});

// 3. åªå–å‰ 4 ç¯‡
const latestPosts = allPosts.slice(0, 4);

// â˜…â˜…â˜… ä¿®æ”¹ 2ï¼šåŠ å…¥ : string é¡å‹å®£å‘Šï¼Œè§£æ±º dateStr ç´…å­— â˜…â˜…â˜…
const formatDate = (dateStr: string) => {
  try {
    if (!dateStr) return new Date().toISOString().slice(0, 10); // å¦‚æœæ²’æ—¥æœŸï¼Œå›å‚³ä»Šå¤©
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return "æ—¥æœŸæœªå®š"; // å¦‚æœæ ¼å¼éŒ¯èª¤
    return d.toISOString().slice(0, 10);
  } catch (e) {
    return "----/--/--"; 
  }
};
---

<BaseLayout pageTitle={pageTitle}>
  
  {/* --- å€å¡Š 0: R-18 è­¦å‘Šå½ˆçª— (Age Verification) --- */}
  <div id="age-gate" class="age-gate-overlay">
    <div class="age-gate-box">
      <div class="warning-icon">ğŸ”</div>
      <h2>æœªæ»¿ 18 æ­²ç¦æ­¢é€²å…¥</h2>
      <p>
        æœ¬ç«™åŒ…å«æˆäººå…§å®¹ (R-18)ã€‚<br>
        å¦‚æœæ‚¨æœªæ»¿ 18 æ­²ï¼Œæˆ–æ‚¨ç•¶åœ°çš„æ³•å¾‹ç¦æ­¢ç€è¦½æ­¤é¡å…§å®¹ï¼Œè«‹ç«‹å³é›¢é–‹ã€‚
      </p>
      <div class="gate-buttons">
        <a href="https://www.google.com" class="btn btn-leave">é›¢é–‹</a>
        <button id="enter-btn" class="btn btn-enter">æˆ‘å·²æ»¿ 18 æ­²ï¼Œé€²å…¥</button>
      </div>
    </div>
  </div>

  {/* --- å€å¡Š 1: Hero Section (ä¸»è¦–è¦º - æ”¹ç‚ºç²‰è‰²ç³») --- */}
  <div class="hero-section">
    <h1>Welcome to <span class="text-gradient">P.SnowcNEWS</span></h1>
    <p class="subtitle">
      ç´³å£«å€‘çš„éš±å¯†è§’è½ã€‚<br>
      é€™è£¡æœ‰ä¸»ç«™çœ‹ä¸åˆ°çš„ã€Œæ·±åº¦ã€å…§å®¹èˆ‡æƒ…å ±ã€‚
    </p>
    <div class="cta-buttons">
      <a href="/blog" class="btn btn-primary">ç€è¦½æ‰€æœ‰ç´³å£«æ–‡</a>
      <a href="https://snowcnews.com" class="btn btn-secondary">å›åˆ°ä¸»ç«™</a>
    </div>
  </div>

  {/* --- å€å¡Š 2: æœ€æ–°æƒ…å ± --- */}
  <div class="latest-news-section">
    <div class="section-header">
      <h2>æœ€æ–°æƒ…å ±</h2>
      <a href="/blog" class="view-all">æŸ¥çœ‹å…¨éƒ¨ &rarr;</a>
    </div>

    <div class="posts-grid">
      {/* é˜²å‘†æ©Ÿåˆ¶ï¼šå¦‚æœæ²’æœ‰æ–‡ç« ï¼Œé¡¯ç¤ºæç¤º */}
      {latestPosts.length === 0 ? (
        <div class="empty-state">
          <p>ğŸš§ ç›®å‰é‚„æ²’æœ‰ä»»ä½•æ–‡ç« ï¼Œæ•¬è«‹æœŸå¾…ï¼ ğŸš§</p>
        </div>
      ) : (
        latestPosts.map((post) => (
          <div class="post-card">
            <a href={post.url} class="card-image-link">
              <div class="card-image">
                 {/* åœ–ç‰‡è™•ç†ï¼šæ”¯æ´å¤šç¨®æ ¼å¼ä¸¦åŠ ä¸Š loading å„ªåŒ– */}
                 <img 
                   src={post.frontmatter.image?.url || post.frontmatter.image?.src || post.frontmatter.image || "/default-og.png"} 
                   alt={post.frontmatter.image?.alt || "å°é¢åœ–"} 
                   decoding="async"
                 />
              </div>
            </a>
            <div class="card-content">
              <a href={post.url} class="card-title-link">
                <h3 class="card-title">{post.frontmatter.title}</h3>
              </a>
              
              <p class="card-date">
                {formatDate(post.frontmatter.pubDate)}
              </p>
              
              <div class="tags">
                {/* â˜…â˜…â˜… ä¿®æ”¹ 3ï¼šåŠ å…¥ : string é¡å‹å®£å‘Šï¼Œè§£æ±º tag ç´…å­— â˜…â˜…â˜… */}
                {post.frontmatter.tags && post.frontmatter.tags.map((tag: string) => (
                  <a href={`/tags/${tag}`} class="tag">#{tag}</a>
                ))}
              </div>
            </div>
          </div>
        ))
      )}
    </div>
  </div>

  {/* --- å€å¡Š 3: ç´³å£«å°èˆª (ç¯„ä¾‹åˆ†é¡) --- */}
  <div class="features-section">
    <h2>ç´³å£«å°èˆª</h2>
    <div class="features-grid">
      <a href="/tags/åŒäººèªŒ" class="feature-item">
        <div class="icon">ğŸ“š</div>
        <h3>åŒäººèªŒ</h3>
        <p>æœ¬å­æƒ…å ±èˆ‡æ¼¢åŒ–ã€‚</p>
      </a>
      <a href="/tags/æˆäººéŠæˆ²" class="feature-item">
        <div class="icon">ğŸ®</div>
        <h3>H-Gameé»ƒæ²¹</h3>
        <p>DLsiteã€Steam æ–°ä½œèˆ‡æ¼¢åŒ–æƒ…å ±ã€‚</p>
      </a>
      <a href="/jump" class="feature-item">
        <div class="icon">ğŸ¯</div>
        <h3>å¯†ç¢¼è·³æ¿</h3>
        <p>ç¥ç§˜æ•¸å­—è·³æ¿å·¥å…·ã€‚</p>
      </a>
    </div>
  </div>

</BaseLayout>

{/* Age Gate é‚è¼¯è…³æœ¬ */}
<script>
  const ageGate = document.getElementById('age-gate');
  const enterBtn = document.getElementById('enter-btn');
  
  const isVerified = localStorage.getItem('snowc_age_verified');

  if (isVerified === 'true') {
    if (ageGate) ageGate.style.display = 'none';
  } else {
    document.body.style.overflow = 'hidden'; // ç¦æ­¢æ»¾å‹•
  }

  if (enterBtn && ageGate) {
    enterBtn.addEventListener('click', () => {
      localStorage.setItem('snowc_age_verified', 'true');
      ageGate.style.opacity = '0';
      document.body.style.overflow = 'auto'; // æ¢å¾©æ»¾å‹•
      setTimeout(() => {
        ageGate.style.display = 'none';
      }, 500);
    });
  }
</script>

<style>
  * { box-sizing: border-box; }

  /* --- R-18 è­¦å‘Šå½ˆçª—æ¨£å¼ --- */
  .age-gate-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(10px);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s;
  }

  .age-gate-box {
    background: #1a1a1a;
    padding: 3rem;
    border-radius: 1rem;
    text-align: center;
    max-width: 500px;
    width: 90%;
    border: 1px solid #333;
    box-shadow: 0 0 30px rgba(236, 72, 153, 0.2);
  }

  .warning-icon { font-size: 4rem; margin-bottom: 1rem; }
  
  .age-gate-box h2 { 
    color: #ec4899;
    font-size: 2rem; 
    margin-bottom: 1rem; 
  }
  
  .age-gate-box p { 
    color: #ccc; 
    line-height: 1.6; 
    margin-bottom: 2rem; 
  }

  .gate-buttons { display: flex; gap: 1rem; justify-content: center; }
  
  .btn-enter {
    background: #ec4899;
    color: white;
    border: none;
    cursor: pointer;
  }
  .btn-enter:hover { background: #db2777; }
  
  .btn-leave {
    background: #333;
    color: white;
  }
  .btn-leave:hover { background: #444; }


  /* --- Hero Section (ç²‰è‰²ç³»èª¿æ•´) --- */
  .hero-section {
    text-align: center;
    padding: 4rem 1rem;
    background: linear-gradient(to bottom, #fff0f5, #ffffff); 
    border-radius: 1rem;
    margin-bottom: 3rem;
  }

  h1 { font-size: 2.5rem; margin-bottom: 1rem; font-weight: 800; }
  
  .text-gradient {
    background-image: linear-gradient(45deg, #ec4899, #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-size: 400%;
  }

  .subtitle { font-size: 1.1rem; color: #555; line-height: 1.6; margin-bottom: 2rem; }

  .cta-buttons { display: flex; gap: 1rem; justify-content: center; }
  
  .btn { padding: 0.8rem 1.5rem; border-radius: 999px; text-decoration: none; font-weight: bold; transition: transform 0.2s; }
  .btn:hover { transform: scale(1.05); }
  
  .btn-primary { background: #ec4899; color: white; } 
  .btn-secondary { background: #f3f4f6; color: #333; }

  /* --- Latest News Section --- */
  .latest-news-section { margin-bottom: 4rem; }
  
  .section-header { display: flex; justify-content: space-between; align-items: end; margin-bottom: 1.5rem; border-bottom: 2px solid #fce7f3; padding-bottom: 0.5rem; }
  .section-header h2 { margin: 0; font-size: 1.8rem; color: #333; }
  .view-all { color: #ec4899; text-decoration: none; font-weight: bold; }
  .view-all:hover { text-decoration: underline; }

  /* --- Card Style --- */
  .posts-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
    gap: 2rem; 
  }
  
  /* é˜²å‘†æ¨£å¼ï¼šç©ºç‹€æ…‹ */
  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    background: #fdf2f8;
    color: #9d174d;
    border-radius: 12px;
    font-weight: bold;
  }

  .post-card { 
    background: white; 
    border-radius: 12px; 
    overflow: hidden; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
    display: flex; 
    flex-direction: column; 
    transition: transform 0.2s; 
  }
  .post-card:hover { transform: translateY(-5px); }

  .card-image-link { 
    display: block; 
    width: 100%; 
    aspect-ratio: 16 / 9; 
  }
  
  .card-image { width: 100%; height: 100%; background-color: #eee; position: relative; }
  .card-image img { width: 100%; height: 100%; object-fit: cover; object-position: center; display: block; }

  .card-content { padding: 1.5rem; display: flex; flex-direction: column; flex-grow: 1; }
  
  .card-title-link { text-decoration: none; color: inherit; }
  .card-title { margin: 0 0 0.5rem 0; font-size: 1.25rem; color: #333; line-height: 1.4; }
  .card-title-link:hover .card-title { color: #ec4899; }
  
  .card-date { font-size: 0.875rem; color: #888; margin-bottom: 0.5rem; }
  
  .tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
  
  .tag { 
    background-color: #fdf2f8; 
    color: #be185d; 
    padding: 0.2rem 0.6rem; 
    border-radius: 999px; 
    font-size: 0.75rem; 
    text-decoration: none; 
    transition: background-color 0.2s; 
    font-weight: 500; 
  }
  .tag:hover { background-color: #fbcfe8; color: #9d174d; }

  /* --- Features Section --- */
  .features-section { text-align: center; margin-bottom: 2rem; }
  .features-section h2 { margin-bottom: 2rem; font-size: 1.8rem; }
  
  .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; }
  
  .feature-item { 
    display: block;
    padding: 2rem; 
    background: #fff; 
    border-radius: 1rem; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
    transition: transform 0.2s, box-shadow 0.2s;
    height: 100%; 
    text-decoration: none !important;
    color: inherit; 
  }

  .feature-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(236, 72, 153, 0.15); 
    background-color: #fff0f5; 
  }

  .icon { font-size: 3rem; margin-bottom: 1rem; }
  
  .feature-item h3 { margin: 0.5rem 0; color: #333; font-size: 1.2rem; }
  .feature-item p { color: #666; font-size: 0.9rem; line-height: 1.5; }
</style>